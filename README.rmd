---
title: "Modelagem de ocupação single-season "
author: "Inês Motta Comarella"
output: html_document
---


Modelo de ocupação single-season single-species para espécies não marcadas de acordo com o proposto por MacKenzie et al. (2002).


## Motivação

Esse script é parte do meu projeto de Iniciação Científica entitulado "Seleção de Hábitat e relações competitivas entre carnívoros em área fragmentada".


## Premissas para a análise

Serão consideradas situações de levantamentos de espécies em N locais específicos realizados em T ocasiões distintas no tempo.
Os locais são ocupados pelas espécies de interesse durante o período da pesquisa, sem novos locais sendo ocupados após o início da pesquisa e nenhum local abandonado antes da interrupção da pesquisa (ou seja, os locais são "fechados").
Em cada ocasião de amostragem, os pesquisadores usam métodos de amostragem projetados para detectar as espécies de interesse.
As espécies nunca são falsamente detectadas em um local quando ausentes, e uma espécie pode ou não ser detectada em um local quando presente. A detecção das espécies em um local também é considerada independente da detecção das espécies em todos os outros locais.
Os dados resultantes para cada site podem ser registrados como um vetor de 1 e 0, denotando detecção e não detecção, respectivamente, para as ocasiões em que o site foi amostrado. O conjunto de tais históricos de detecção é usado para estimar a quantidade de interesse, a proporção de locais ocupados pelas espécies.

## Estrutura do diretório
``` bash
projeto
|   README.Rmd
|___data
|   |   occurrence.xlsx
|   |   variables.xlsx
|___figs
|___output
```

## Inputs

## Modelagem

### Detecção

### Ocupação

## Outputs

São necessário dois inputs, uma tabela com as características dos sites
There are two inputs to the analysis, the spacial variables charactherizing each site, and the species occurence table. The blank cells will be consider a *NAN*.  

#### Species data

We used occurence based on presence-absence, so it's not possible to estimate abundance. Each especies has it's own occurence table formated as a sites x occasion table, so the site are in the columns and the occasion in the rows. An occasion is the period of time you are considering to register the species occurence, it can be a day, 3 days, 5 days, etc. I've tests some occasion based on works published, so I could choose what is best.

I included an extra-step in this case to remove the species name of the occurence table so I could share my results.



## Model analysis
***
The modeling is divided in 4 main steps, 1. input variables and species data, 2. analyse the detection bias, 3. model the occupancy prediction and 4. export the outputs. The variable selection follows a stepwise method. 

Let's see how it works:

### Importing data
The inputs are XLSX file extension, so we'll use `read_excel()` from "readxl" package

* Variables

The variables are the same to all species, as they characterize the enviroment. 

* Species
It is a single-species modeling.

```{r Read species data, eval=FALSE}
cfm <- read_excel("./data/occu-10x1.xlsx",
                  sheet = "sp1") ## read species 1 occurence table
```


### Detection bias model

##### Detection bias hipothesis
Species detection can be biased by the site conditions p(var), or by the sampling time p(t) or maybe it can be random p(.). So the first step to model the detection bias is to test those models hipothesis.

```{r Detection bias hipothesis, eval=FALSE}
# Detection bias hipothesis
dec1.cfm <- occu( ~ 1 ~ 1, cfm.umf) # null model
dec2.cfm <- occu( ~ obsNum ~ 1, cfm.umf) # sampling time bias
dec3.cfm <- occu( ~ ele + DistBorda_PLAN + RAI_Hum ~ 1, cfm.umf) # covariates bias
```

The `occu( ~ detection ~ occupancy)` function is a two-sided function and consider the detection and the occupancy.  

**Atention**

The model selection is based on **Akaike Information Criterion (AIC)**, and it's important to look at the result to decide the next step.  
**Output**

Write a table with the results, they can be usefull to check the results. Because the output is a S4 class method it is not possible to simply write it automatically, so it has to be by hand.

#### Intermadiate step

In case the model selected is a function of covariates p(var), then an extra-step is necessary. This is necessary to evaluate the fixed effect terms in the global model.

**Output 1**

The first one is the models ranked by AIC, and is based on the models selected in this table is going to used in the occupancy modeling. 

```{r det-dredge(), eval=FALSE}
dd.cfm <- dredge(dec3.cfm)
```

**Output 2**

The second output is important to describe the covariates influence in the detection, and is basically the mean values, and its associated standard deviations, of the covariate parameters of the ranked models. 


```{r echo=FALSE, message=FALSE}
library(readxl)
library(vegan)
library(unmarked)
library(MuMIn)
VariaveisExp <-
  read_excel("./data/VariaveisExp.xlsx", sheet = "VarExp")
Var <- VariaveisExp[, c(5:8, 10)]
# Binding person and car presence in one single variable
Var <- cbind(Var, VariaveisExp[, 14] + VariaveisExp[, 15])
# Standardizing data
Var <-
  decostand(Var, method = "standardize", MARGIN = 2)
cfm <- read_excel("./data/occu-10x1.xlsx",
                  sheet = "sp1")
cfm <- cfm[, -1]
cfm.umf <- unmarkedFrameOccu(y = cfm, siteCovs = Var)
dec3.cfm <- occu( ~ ele + DistBorda_PLAN + RAI_Hum ~ 1, cfm.umf)
dd.cfm <- dredge(dec3.cfm)

table <- as.matrix(dd.cfm)
importancia.var.cfm <- matrix(NA, nrow = 5, ncol = 6)
rownames(importancia.var.cfm) <-
  c("p(Int)", "psi(Int)", "p(DsB_PLA)", "p(ele)",
    "p(RAI_Hum)")
colnames(importancia.var.cfm) <-
  c("coef.mean",
    "coef.sd",
    "delta.mean",
    "delta.sd",
    "w.mean",
    "w.sd")

for (i in 1:5) {
  temp <- na.omit(table[, c(i, 9, 10)])
  sd.t <- apply(temp, 2, sd)
  mean.t <- apply(temp, 2, mean)
  importancia.var.cfm[i, ] <-
    c(mean.t, sd.t)
}
importancia.var.cfm


```


#### Final detection model function







